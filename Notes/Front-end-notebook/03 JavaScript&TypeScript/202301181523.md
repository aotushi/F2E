---
alias:
---



### asyncå’Œawaitç»“åˆä½¿ç”¨

#### æ³¨æ„äº‹é¡¹

```
1.	awaitå¿…é¡»å†™åœ¨asyncå‡½æ•°ä¸­, ä½†asyncå‡½æ•°ä¸­å¯ä»¥æ²¡æœ‰await
2.	å¦‚æœawaitçš„promiseå¤±è´¥äº†, å°±ä¼šæŠ›å‡ºå¼‚å¸¸, éœ€è¦é€šè¿‡try...catchæ•è·å¤„ç†

```



#### æ¡ˆä¾‹+++

```js
//https://www.cnblogs.com/fundebug/p/10095355.html

async function async1() {
    console.log("async1 start");
    await async2();
    console.log("async1 end");
}

async function async2() {
    console.log("async2");
}

console.log("script start");

setTimeout(function() {
    console.log("setTimeout");
}, 0);

async1();

new Promise(function(resolve) {
    console.log("promise1");
    resolve();
}).then(function() {
    console.log("promise2");
});

console.log("script end");
```





```js
//awaitå³ä¾§ä¸æ˜¯promiseå¯¹è±¡
async function main(){
    let result = await 123;
    console.log(result);
}
main();//æ‰§è¡Œç»“æœæ˜¯123


//å³ä¾§ä¸ºpromiseç±»å‹çš„å€¼ å³ä½¿æ˜¯å¼‚æ­¥å‡½æ•°,ä¹Ÿèƒ½æ­£å¸¸è·å–æˆåŠŸçš„ç»“æœ
async function main(){
    let result = await (new Promise((resolve, reject)=>{
        resolve('ok');
    }));
    console.log(result);
}
main();//æ‰§è¡Œç»“æœæ˜¯ok

async function main(){
    let p = Promise.resolve('ok');
    let result = await p;
    console.log(result);
}
main();//æ‰§è¡Œç»“æœæ˜¯ok

//å¦‚æœpromiseçš„å¯¹è±¡æ˜¯å¤±è´¥ ä¼šæŠ›å‡ºé”™è¯¯,ä½¿ç”¨try..catch
async function main(){
    try(
         let p = await (new Promise(resolve, reject)=>{
        	reject('error');
        });
    	console.log(p);
    )catch(e){
       console.log(e);
    }
}
main();//è¾“å‡ºç»“æœä¸ºcatchå‡½æ•°è¾“å‡ºçš„'error'
```



#### æ¡ˆä¾‹2

```js
- è¯»å–resourceæ–‡ä»¶å¤¹ä¸‹çš„1-3ä¸ªHTMLæ–‡ä»¶

const fs=require('fs');
const {promisify}=require('util');
let readfile=promisify(fs.readFile);

async function main(){
    let p1=await readfile('./resource/1.html');
    let p2=await readfile('./resource/2.html');
    let p3=await readfile('./resource/3.html');

    console.log(p1+p2+p3);
}
mian();
```



#### æ¡ˆä¾‹3-å°è£…ajax

```html
- å°è£…ajaxå‡½æ•°,å®ç°è·å–urlæ¥å£ç»“æœ
<button>ç‚¹å‡»è·å–å¤©æ°”</button
<script>
function sendAjax(url){
    let xhr=new XMLHttpRequest();
    xhr.open('GET', url);
    xhr.send();
    xhr.onreadystatechange=function(){
       return new Promise((resolve, reject)=>{
        if(xhr.readyState === 4){
            if(xhr.status>=200 && xhr.status<300){
                resolve(xhr.responseText);
            }else{
                reject(xhr.status)
            }
        }
    }
   })
}

const btn=document.querySelector('button');
btn.onclick=async function(){
	let url='';
	let result = await sendAjax(url);
	console.log(result);
    <!--promiseæ–¹æ³• sendAjax.then()   -->
                                                
};
</script>
```



### mapä¸­éå†ä½¿ç”¨asyncå‡½æ•°

```js
//https://zhuanlan.zhihu.com/p/88695806

å½“ async å‡½æ•°è¢«æ‰§è¡Œæ—¶ï¼Œå°†ç«‹å³è¿”å› pending çŠ¶æ€çš„Promiseï¼ˆ Promise æ˜¯ Truthy çš„ï¼‰ï¼å› æ­¤ï¼Œåœ¨ map å¾ªç¯æ—¶ï¼Œä¸ä¼šç­‰å¾… await æ“ä½œå®Œæˆï¼Œè€Œæ˜¯ç›´æ¥è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œæ‰€ä»¥åº”å½“é…åˆ for å¾ªç¯ä½¿ç”¨ asyncã€‚
å¯¹äº forEach è€Œè¨€ï¼Œå‚è€ƒ MDN ä¸­å®ƒçš„ Polyfill å¯çŸ¥ï¼Œè‹¥å›è°ƒå‡½æ•°ä¸ºå¼‚æ­¥æ“ä½œï¼Œå®ƒå°†ä¼šè¡¨ç°å‡ºå¹¶å‘çš„æƒ…å†µï¼Œå› ä¸ºå®ƒä¸æ”¯æŒç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆåå†è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ã€‚


//æ¥ä¸ªä¾‹å­: è‡ªå®šä¹‰Sleepå‡½æ•°é˜»å¡ä»£ç ä¸€æ®µæ—¶é—´
//æ–¹æ¡ˆ1
const sleep = ms => new Promise(resolve=>{
  setTimeout(()=>{
    resolve()
  },ms)
});
const mapResult = [1,2].map(async num => {   //ä½¿ç”¨asyncå‡½æ•°åmapçš„è¿”å›å€¼ä¸º //[Promise{<pending>}, Promise{<pending>]}
  await sleep(3000);
})

//æ–¹æ¡ˆ2
const sleep = wait => new Promise(resolve=>setTimout(resolve, wait));
const __main = async function () {
  const tasks = [1,2,3];
  let results = await tasks.reduce(async (previousValue, currentValue) => {
    let results = await previousValue;
    console.log(`task ${currentValue} start`);
    await sleep(1000 * currentValue);
    console.log(`${currentValue}`);
    console.log(`task ${currentValue} end`);
    results.push(currentValue);
    return results;
  }, []);
  console.log(results);
}
__main();
```



### ES2022- await

> https://h3manth.com/ES2022/

> await outside of async functions in modules

```javascript
// say this is index.mjs

// fails
await Promise.resolve('ğŸ');
// â†’ SyntaxError: await is only valid in async function

// fix with wrapping
(async function() {
  await Promise.resolve('ğŸ');
  // â†’ ğŸ‰
}());

// to top-level await
await Promise.resolve('ğŸ') // 'ğŸ'
const i18n = await import(`./content-${language}.mjs`);
```

