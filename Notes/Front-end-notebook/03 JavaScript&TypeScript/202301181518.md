---
alias:
---



### Promiseå®ç° ğŸš©ğŸš©ğŸš©

> https://juejin.cn/post/6945319439772434469
>
> éå¸¸é‡è¦çš„ä¸€é“é¢˜.éœ€è¦å¤šé˜…è¯»å¤šç†è§£,Promiseç†è§£çš„å¹¶ä¸å¥½



```javascript
//version 1 å®ç°åŸºæœ¬åŠŸèƒ½

const PENDING = 'pending'
const 'FULFILLED' = 'fulfilled'
const 'REJECTED' = 'rejected'

class MyPromise {
  constructor(executor) {
    executor(this.resolve, this.reject)
  }
  
  status = PENDING
  value = null
  reason = null
  
  resolve = (value) => {
    if (this.status === PENDING) {
      this.status = FULFILLED
      this.value = value
    }
  }
  
  reject = (reason) => {
    if (this.status === PENDING) {
      this.status = REJECTED
      this.value = reason
    }
  }
  
  then(onFulfilled, onRejected) {
    if (this.status === FULFILLED) {
      onFulfilled(this.value)
    }
    else if (this.status === Rejected) {
      onRejected(this.reason)
    }
  }
}
```



```javascript
//version 2
const PENDING = 'pending'
const FULFILLED = 'fulfilled'
const REJECTED = 'rejected'

class MyPromise {
  constructor(executor) {
    executor(this.resolve, this.reject)
  }
  
  status = PENDING
  value = null
  reason = null
  
  // æ·»åŠ å¼‚æ­¥å¤„ç†
  onFulfilledCallback = null
  onRejectedCallback = null
  
  resolve = (value) => {
    if (this.status === PENDING) {
      this.status = FULFILLED
      this.value = value
      
      //æ·»åŠ å¼‚æ­¥å¤„ç†
      this.onFulfilledCallback && this.onFulfilledCallback(this.value)
    }
  }
  
  reject = (reason) => {
    if (this.status === PENDING) {
      this.status = REJECTED
      this.value = reason
      
      //æ·»åŠ å¼‚æ­¥å¤„ç†
      this.onRejectedCallback && this.onRejectedCallback(this.reason)
    }
  }
  
  
  then(onFulfilled, onRejected) {
    if (this.status === FULFILLED) {
      onFulfilled(this.value)
    }
    else if (this.status === REJECTED) {
      onRejected(this.value)
    }
    else if (this.status === PENDING) {
      // å› ä¸ºä¸çŸ¥é“åé¢çŠ¶æ€çš„å˜åŒ–,æ‰€ä»¥å°†æˆåŠŸå’Œå¤±è´¥çš„å›è°ƒå‚¨å­˜èµ·æ¥
      // ç­‰åˆ°æ‰§è¡ŒæˆåŠŸå¤±è´¥å‡½æ•°çš„æ—¶å€™å†è¿›è¡Œä¼ é€’
      onFulfilledCalback = onFulfilled
      onRejectedCallback = onRejected
    }
  }
}
```



```javascript
// version 3 å®ç°thenæ–¹æ³•å¤šæ¬¡è°ƒç”¨æ·»åŠ å¤šä¸ªå¤„ç†å‡½æ•°

const PENDING = 'pending'
const FULFILLED = 'fulfilled'
const REJECTED = 'rejected'

class MyPromise {
  constructor(executor) {
    executor(this.resolve, this.reject)
  }
  
  status = PENDING
  value = null
  reason = null
  
  //
  onFulfilledCallback = []
  onRejectedCallback = []
  
  resolve = (value) => {
    if (this.status === PENDING) {
      this.status = FULFILLED
      this.value = value
      
      //this.onFulfilledCallback.length && this.onFulfilledCallback.shift()(value) åªä¼šæ‰§è¡Œä¸€æ¬¡
      while(this.onFulfilledCallback.length) {
        this.onFulfilledCallback.shift()(value)
      }
    }
  }
  
  reject = (reason) => {
    if (this.status === PENDING) {
      this.status = REJECTED
      this.value = reason
      
      //this.onRejectedCallback.length && this.onRejectedCallback.shift()(reason)
      while(this.onRejectedCalback.length) {
        this.onRejectedCallback.shift()(reason)
      }
    }
  }
  
  then(onFulfilled, onRejected) {
    if (this.status === FULFILLED) {
      onFulfilled(this.value)
    }
    else if (this.status === REJECTED) {
      onRejected(this.value)
    }
    else if (this.status === PENDING) {
      this.onFulfilledCallback.push(onFulfilled)
      this.onRejectedCallback.push(onRejected)
    }
  }
}
```



4 å®ç°thenæ–¹æ³•çš„é“¾å¼è°ƒç”¨

thenæ–¹æ³•è¦é“¾å¼è°ƒç”¨å°±éœ€è¦è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡

thenæ–¹æ³•é‡Œé¢returnä¸€ä¸ªè¿”å›å€¼ä½œä¸ºä¸‹ä¸€ä¸ªthenæ–¹æ³•çš„å‚æ•°,å¦‚æœreturnä¸€ä¸ªPromiseå¯¹è±¡,é‚£ä¹ˆå°±éœ€è¦åˆ¤æ–­å®ƒçš„çŠ¶æ€

```javascript
class MyPromise {
  //...
  then(onFulfilled, onRejected) {
    //ä¸ºäº†é“¾å¼è°ƒç”¨è¿™é‡Œç›´æ¥åˆ›å»ºä¸€ä¸ª MyPromise, å¹¶åœ¨åé¢returnå‡ºå»
    const promise2 = new MyPromise((resolve, reject) => {
      //è¿™é‡Œçš„å†…å®¹åœ¨æ‰§è¡Œå™¨ä¸­,ä¼šç«‹å³æ‰§è¡Œ
      if (this.status === FULFILLED) {
        //è·å–æˆåŠŸå›è°ƒçš„æ‰§è¡Œç»“æœ
        const x = onFulfilled(this.value)
        //ä¼ å…¥ resolvePromise é›†ä¸­å¤„ç†
        resolvePromise(x, resolve, reject)
      }
      else if (this.status === REJECTED) {
        onRejected(this.value)
      }
      else if (this.status === PENDING) {
        this.onFulfilledCallback.push(onFulfilled)
        this.onRejectedCallback.push(onRejected)
      }
    })
    return promise2
  }
}

function resolvePromise(x, resolve, reject) {
  if (x instanceof MyPromise) {
    //æ‰§è¡Œx, è°ƒç”¨thenæ–¹æ³•, ç›®çš„æ˜¯å°†å…¶çŠ¶æ€å˜ä¸º fulfilled æˆ– rejected
    // x.then(value => resolve(value), reason=>reject(reason))
    //ç®€åŒ–ä¹‹å
    x.then(resolve, reject)
  }
  else {
    //æ™®é€šçº¸
    resolve(x)
  }
}
```



5 thenæ–¹æ³•é“¾å¼è°ƒç”¨è¯†åˆ« Promise æ˜¯å¦è¿”å›è‡ªå·±

å¦‚æœthenæ–¹æ³•è¿”å›çš„æ˜¯è‡ªå·±çš„Promiseå¯¹è±¡,åˆ™ä¼šå‘ç”Ÿå¾ªç¯è°ƒç”¨,è¿™ä¸ªæ—¶å€™ç¨‹åºä¼šæŠ¥é”™

```javascript
//test.js

const promsie = new MyPromise((resolve, reject) => {
  resolve(100)
})

const p1 = promise.then(value => {
  console.log(value)
  return p1
})
```

ä½¿ç”¨åŸç”ŸPromiseæ‰§è¡Œä¸Šé¢çš„ä»£ç ,ä¼šæŠ¥ç±»å‹é”™è¯¯

```javascript
Uncaught (in promise) TypeError: Chaining cycle detected for promise #<Promise>
```

åœ¨MyPromiseä¸­å®ç°ä¸€ä¸‹:

```javascript
class MyPromise {
  ....
  then(onFulfilled, onRejected) {
    const promise2 = new MyPromise((resolve,reject)=> {
      if (this.status === FULFILLED) {
        const x = onFulfilled(this.value)
      	//resolvePromise é›†ä¸­å¤„ç†,å°†promise2 ä¼ å…¥
      	resolvePromise(promise2, x, resolve, reject)
      }
      else if (this.status === REJECTED) {
        onRejected(this.reason)
      }
      else if (this.status === PENDING) {
        this.onFulfilledCallback.push(onFulfilled)
        this.onRejectedCallback.push(onRejected)
      }
    })
    return promise2
  }
}

function resolvePromise(promise2, x, resolve, reject) {
  //å¦‚æœç›¸ç­‰äº†,è¯´æ˜returnçš„æ˜¯è‡ªå·±,æŠ›å‡ºç±»å‹é”™è¯¯å¹¶è¿”å›
  if (promise2 === x) {
    return TypeError(new TypeError('Chaing cycle detected for promise #<Promise>'))
  }
  
  if (x instanceof MyPromise) {
    x.then(resolve, reject)
  }else {
    resolve(x)
  }
}
```

æ‰§è¡ŒæŠ¥é”™:

```javascript
resolvePromise(promise2, x, resolve, reject);
                       ^

ReferenceError: Cannot access 'promise2' before initialization
```

æˆ‘ä»¬å¿…é¡»è¦ç­‰ promise2 å®Œæˆåˆå§‹åŒ–ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±è¦ç”¨ä¸Šå®å¾®ä»»åŠ¡å’Œäº‹ä»¶å¾ªç¯çš„çŸ¥è¯†äº†ï¼Œè¿™é‡Œå°±éœ€è¦åˆ›å»ºä¸€ä¸ªå¼‚æ­¥å‡½æ•°å»ç­‰å¾… promise2 å®Œæˆåˆå§‹åŒ–ï¼Œå‰é¢æˆ‘ä»¬å·²ç»ç¡®è®¤äº†åˆ›å»ºå¾®ä»»åŠ¡çš„æŠ€æœ¯æ–¹æ¡ˆ --> `queueMicrotask`

```javascript
//MyPromise

class MyPromise {
  //...
  then(onFulfilled, onRejected) {
    const promise2 = new MyPromise((resolve, reject) => {
      if (this.status === FULFILLED) {
        //åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡ ç­‰å¾…promise2 å®Œæˆåˆå§‹åŒ–
        queueMicrotask(() => {
          //è·å–æˆåŠŸå›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ
          const x = onFulfilled(this.value)
          //ä¼ å…¥ resolvePromise é›†ä¸­å¤„ç†
          resolvePromise(promise2, x, resolve, reject)
        })
      } else if (this.status === REJECTED) {
        //...
      }
    })
    
    return promise2
  }
}
```



6 æ•è·é”™è¯¯åŠthené“¾å¼è°ƒç”¨å…¶ä»–çŠ¶æ€ä»£ç è¡¥å……

6.1æ•è·æ‰§è¡Œå™¨é”™è¯¯

```javascript
// MyPromise

constructor(executor) {
  try {
    executor(this.resolve, this.reject)
  } catch(error) {
    this.reject(error)
  }
}
```

éªŒè¯:

```javascript
const MyPromise = require('./MyPromise')
const promise = new MyPromise((resolve, reject) => {
    // resolve('success')
    throw new Error('æ‰§è¡Œå™¨é”™è¯¯')
})
 
promise.then(value => {
  console.log(1)
  console.log('resolve', value)
}, reason => {
  console.log(2)
  console.log(reason.message)
})
```

æ‰§è¡Œç»“æœ

```javascript
2
æ‰§è¡Œå™¨é”™è¯¯
```

6.2thenæ‰§è¡Œæ—¶é”™è¯¯æ•è·

```javascript
//MyPromise

then(onFulfilled, onRejected) {
  const promise2 = new MyPromise((resolve, reject) => {
    if (this.status === FULFILLED) {
    	queueMicrotask(() => {
        try {
          const x = onFulfilled(this.value)
          resolvePromise(promise2, x, resolve, reject)
        } catch(error) {
          reject(error)
        }
      })
    }
    else if (this.status === REJECTED) {
      cosnt x = onRejected(this.reason)
      resolvePromise(promise2, x, resolve, reject)
    }
    else if (this.status === PENDING) {
      this.onFulfilledCallback.push(onFulfilled)
      this.onRejectedCallback.push(onRejected)
    }
  })
}
```

7 å¯¹rejectedå’ŒpendingçŠ¶æ€è¿›è¡Œæ”¹é€ ,å‚è€ƒfulfilled

> æ”¹é€ å†…å®¹:
>
> 1. å¢åŠ å¼‚æ­¥çŠ¶æ€ä¸‹çš„é“¾å¼è°ƒç”¨
> 2. å¢åŠ å›è°ƒå‡½æ•°æ‰§è¡Œç»“æœçš„åˆ¤æ–­
> 3. å¢åŠ è¯†åˆ« Promise æ˜¯å¦è¿”å›è‡ªå·±
> 4. å¢åŠ é”™è¯¯æ•è·

```javascript
//MyPromise.js

then(onFulfilled, onRejected) {
  const promise2 = new MyPromise((resolve, reject) => {
  	if (this.status === FULFILLED) {
      queueMicrotask(() => {
        try {
          const x = onFulfilled(this.value)
          resolveProimse(promise2, x, resolve, reject)
        } catch(error) {
          reject(error)
        }
      })
    }
    else if (this.status === REJECTED) {
      queueMicrotask(() => {
        try {
          const x = onRejected(this.reason)
          resolvePromise(promise2, x, resolve, reject)
        } catch(error) {
          reject(error)
        }
      })
    }
    else if (this.status === PENDING) {
      this.onFulfilledCallback.push(() => {
        queueMicrotask(() => {
          try {
            const x = onFulfilled(this.value)
            resolvePromise(promise2, x, resolve, reject)
          } catch(error) {
            reject(error)
          }
        })
      })
      this.onRejectedCallback.push(() => {
        queueMicrotask(() => {
          try {
            const x = onRejected(this.reason)
            resolvePromise(promise2, x, resolve, reject)
          } catch(error) {
            reject(error)
          }
        })
      })
    }
  })
  
  reurn promise2
}
```



8 thenä¸­çš„å‚æ•°å˜ä¸ºå¯é€‰

ä¸Šé¢æˆ‘ä»¬å¤„ç† then æ–¹æ³•çš„æ—¶å€™éƒ½æ˜¯é»˜è®¤ä¼ å…¥ onFulfilledã€onRejected ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œä½†æ˜¯å®é™…ä¸ŠåŸç”Ÿ Promise æ˜¯å¯ä»¥é€‰æ‹©å‚æ•°çš„å•ä¼ æˆ–è€…ä¸ä¼ ï¼Œéƒ½ä¸ä¼šå½±å“æ‰§è¡Œã€‚

```javascript
//MyPromise

then(onFulfilled, onRejected) {
  // å¦‚æœä¸ä¼ ,å°±ä½¿ç”¨é»˜è®¤å‡½æ•°
  onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : value => value
  onRejected = typeof onRejected === 'function' ? 
onRejected : reason => {throw reason}
  
  const promise2 = new MyPromise((resolve, reject) => {
    
  })
}
```



9 å®ç°resolveä¸rejectçš„é™æ€è°ƒç”¨

` Promise.resolve` æ¥è¿”å›ä¸€ä¸ª Promise å¯¹è±¡

```javascript
MyPromise {
  //...
  
  //resolveé™æ€æ–¹æ³•
  static resolve(parameter) {
    if (parameter instanceof MyPromise) {
      return parameter
    }
    
    //è½¬æˆå¸¸è§„æ–¹å¼
    return new MyPromise(resolve => {
      resolve(parameter)
    })
  }
  
  //rejecé™æ€æ–¹æ³•
  static reject(parameter) {
    return new MyPromise((resolve, reject) => {
      
    })
  }
}
```





### Promiseå®ç°2

> https://github.com/xieranmaya/blog/issues/3
>
> https://juejin.cn/post/6844903625769091079
>
> https://juejin.cn/post/6844904077537574919
>
> https://juejin.cn/post/6945319439772434469
>
> æ˜é‡‘æ¥è‡ªæœç´¢promiseçš„å‰å‡ ä½ç»“æœ


